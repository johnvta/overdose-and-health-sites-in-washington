<!DOCTYPE html>
<html>
<head>
    <!-- Leaflet CSS for map styling -->
	<title>Overdose Web Map</title>
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>
	<link href="style.css" rel="stylesheet">
</head>
<body>
    <!-- Leaflet and jQuery scripts -->
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
	
    <div id="wrapper">
		<div id="header">
            <h1>Overdose & Health Sites in Washington</h1>
        </div>
		<div id="map"></div>
	</div>

	<script>
        // Initialize the map centered on Washington State
        var map = L.map('map').setView([47.5, -120.7401], 7);

        // Add base layer from OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors',
                maxZoom: 15,
                minZoom: 5
            }).addTo(map);
        
        /* BEGINNING OF HEALTH SITES SECTION */ 
        // Variables to hold health sites data
        var hospitalLayer = L.layerGroup();
        var emsLayer = L.layerGroup();
        var otpLayer = L.layerGroup();
        var nonOpioidLayer = L.layerGroup();        

        // Load health sites data from GeoJSON file and add to the map
        $.getJSON("data/health_sites_wa.geojson",function(data){
            L.geoJson(data, {
                // Function to bind popup information for each health site
                onEachFeature: function(feature, layer) {
                    layer.bindPopup(
                        'Type: ' + feature.properties.amenity +
                        '<br>Name: ' + feature.properties.name +
                        '<br>City: ' + feature.properties.city
                    );
                },
                // Function to choose marker icon based on amenity type
                pointToLayer: function(feature, latlng) {
                    var marker;
                    if (feature.properties.amenity === "Hospital"){ 
                        marker = L.marker(latlng, {icon: hospitalIconInstance});
                        hospitalLayer.addLayer(marker);
                    } else if (feature.properties.amenity === "EMS (Emergency Medical Services)") {
                        marker = L.marker(latlng, {icon: emsIconInstance});
                        emsLayer.addLayer(marker);
                    } else if (feature.properties.amenity === "OTP (Opioid Treatment Programs) Facility") {
                        marker = L.marker(latlng, {icon: otpIconInstance});
                        otpLayer.addLayer(marker);
                    } else {
                        marker = L.marker(latlng, {icon: nonOpioidIconInstance});
                        nonOpioidLayer.addLayer(marker);
                    }
                    return marker;
                }
            })
        });  

        // Create standard icon for Hospital
        var hospitalIcon = L.Icon.extend({ 
            options:{ iconUrl: 'icons/hospital.png', iconSize: [24,24] }
        });
        var hospitalIconInstance = new hospitalIcon();

        // Create standard icon for Emergency Medical Services (EMS)
        var emsIcon = L.Icon.extend({ 
            options:{ iconUrl: 'icons/ambulance.png', iconSize: [12,12] }
        });   
        var emsIconInstance = new emsIcon();

        // Create standard icon for OTP (Opioid Treatment Programs) Facility
        var otpIcon = L.Icon.extend({ 
            options:{ iconUrl: 'icons/opioid.png', iconSize: [12,12] }
        });   
        var otpIconInstance = new otpIcon();  
        
        // Create standard icon for Non-Opioid Substance User Disorder Facility
        var nonOpioidIcon = L.Icon.extend({ 
            options:{ iconUrl: 'icons/nonopioid.png', iconSize: [12,12] }
        });   
        var nonOpioidIconInstance = new nonOpioidIcon();        

        // Toggle functiions for health site layers
        function toggleHospitals() {
            if (map.hasLayer(hospitalLayer)) {
                map.removeLayer(hospitalLayer);
            } else {
                map.addLayer(hospitalLayer);
            }
        }

        function toggleEMS() {
            if (map.hasLayer(emsLayer)) {
                map.removeLayer(emsLayer);
            } else {
                map.addLayer(emsLayer);
            }
        }

        function toggleOTP() {
            if (map.hasLayer(otpLayer)) {
                map.removeLayer(otpLayer);
            } else {
                map.addLayer(otpLayer);
            }
        }

        function toggleNonOpioid() {
            if (map.hasLayer(nonOpioidLayer)) {
                map.removeLayer(nonOpioidLayer);
            } else {
                map.addLayer(nonOpioidLayer);
            }
        }

        /* BEGINNING OF FATAL OVERDOSE SECTION */
        // Variables to hold fatal overdose count per county layers
        var fatalOverdoseLayer2003 = L.layerGroup();
        var fatalOverdoseLayer2013 = L.layerGroup();

        // Load fatal overdose data for 2003-2007
        $.getJSON("data/fatal_overdose_count_wa_2003.geojson", function(data){
            fatalOverdoseLayer2003 = L.geoJson(data, {
                style: fatalStyle,
                // Function to bind popup information for each county's fatal overdose data
                onEachFeature: function(feature, layer) {
                    layer.bindPopup(
                        'County: '+ feature.properties.County +
                        '<br>Population: '+ feature.properties.Population +
                        '<br>Fatal Overdose Count: '+ feature.properties.Count +
                        '<br>Range: '+ feature.properties.Range
                    );
                }
            }).addTo(fatalOverdoseLayer2003);
        });

        // Load fatal overdose data for 2013-2017
        $.getJSON("data/fatal_overdose_count_wa_2013.geojson", function(data){
            fatalOverdoseLayer2013 = L.geoJson(data, {
                style: fatalStyle,
                // Function to bind popup information for each county's fatal overdose data
                onEachFeature: function(feature, layer) {
                    layer.bindPopup(
                        'County: ' + feature.properties.County +
                        '<br>Population: ' + feature.properties.Population +
                        '<br>Fatal Overdose Count: ' + feature.properties.Count +
                        '<br>Range: ' + feature.properties.Range
                    );
                }
            }).addTo(fatalOverdoseLayer2013);
        });

        // Function to set color classification based on fatal overdose count
        function fatalSetColor(x){
            return x > 228 ? '#006d2c' :   // Very High
                    x > 82 ? '#2ca25f' :   // High
                    x > 20 ? '#66c2a4' :   // Medium
                    x >= 1 ? '#99d8c9' :   // Low
                             '#a6bddb' ;   // Uncategorized
        }

        // Function to set style for the fatal overdose layers
        function fatalStyle(feature) {
            return {
                fillColor: fatalSetColor(feature.properties.Count),
                fillOpacity: 0.85,
                weight: 1,
                opacity: 1,
                color: 'white',
                dashArray: '0'
            };
        }        

        /* BEGINNING OF NON-FATAL OVERDOSE SECTION */
        // Variables to hold non fatal overdose count per county layers
        var nonFatalOverdoseLayer2003 = L.layerGroup();
        var nonFatalOverdoseLayer2013 = L.layerGroup();

        // Load overdose data for 2003-2007
        $.getJSON("data/nonfatal_overdose_count_wa_2003.geojson", function(data){
            nonFatalOverdoseLayer2003 = L.geoJson(data, {
                style: nonFatalStyle,
                // Function to bind popup information for each county's fatal overdose data
                onEachFeature: function(feature, layer) {
                    layer.bindPopup(
                        'County: '+ feature.properties.County +
                        '<br>Population: '+ feature.properties.Population +
                        '<br>Fatal Overdose Count: '+ feature.properties.Count +
                        '<br>Range: '+ feature.properties.Range
                    );
                }
            }).addTo(nonFatalOverdoseLayer2003);
        });

        // Load non fatal overdose data for 2013-2017
        $.getJSON("data/nonfatal_overdose_count_wa_2013.geojson", function(data){
            nonFatalOverdoseLayer2013 = L.geoJson(data, {
                style: nonFatalStyle,
                // Function to bind popup information for each county's fatal overdose data
                onEachFeature: function(feature, layer) {
                    layer.bindPopup(
                        'County: ' + feature.properties.County +
                        '<br>Population: ' + feature.properties.Population +
                        '<br>Fatal Overdose Count: ' + feature.properties.Count +
                        '<br>Range: ' + feature.properties.Range
                    );
                }
            }).addTo(nonFatalOverdoseLayer2013);
        });

        // Function to set color classification based on overdose count
        function nonFatalSetColor(x){
            return x > 1994 ? '#08519c' :   // Very High
                    x > 957 ? '#3182bd' :   // High
                    x > 166 ? '#6baed6' :   // Medium
                    x > 46 ? '#bdd7e7' :   // Low
                             '#eff3ff' ;   // Very Low
        }

        // Function to set style for the base layers
        function nonFatalStyle(feature) {
            return {
                fillColor: nonFatalSetColor(feature.properties.Count),
                fillOpacity: 0.85,
                weight: 1,
                opacity: 1,
                color: 'white',
                dashArray: '0'
            };
        }

        // Layer control for overdose polygons and health site points
        var baseLayers = {
            "Fatal Overdose 2003-2007": fatalOverdoseLayer2003,
            "Fatal Overdose 2013-2017": fatalOverdoseLayer2013, 
            "Non-Fatal Overdose 2003-2007": nonFatalOverdoseLayer2003,
            "Non-Fatal Overdose 2013-2017": nonFatalOverdoseLayer2013
        };

        var overlayLayers = {
            "<img src='icons/hospital.png' style='width: 15px; height: 15px; vertical-align: middle;'> Hospitals": hospitalLayer,
            "<img src='icons/ambulance.png' style='width: 15px; height: 15px; vertical-align: middle;'> EMS": emsLayer,
            "<img src='icons/opioid.png' style='width: 15px; height: 15px; vertical-align: middle;'> OTP Facilities": otpLayer,
            "<img src='icons/nonopioid.png' style='width: 15px; height: 15px; vertical-align: middle;'> Non-Opioid Treatment": nonOpioidLayer
        };

        // Add layer control to map
        L.control.layers(baseLayers, overlayLayers, { collapsed: false }).addTo(map);

        /* BEGINNING OF LEGEND SECTION */
        // Create Leaflet control object for the legend
        var fatalLegend = L.control({ position: 'bottomright' });
        fatalLegend.onAdd = function(map) {
            var div = L.DomUtil.create('div', 'legend');
            // Array of legend items
            var fatalLegendItems = [
                { color: '#006d2c', label: 'Very High: 229+' },
                { color: '#2ca25f', label: 'High: 83-228' },
                { color: '#66c2a4', label: 'Medium: 21-82' },
                { color: '#99d8c9', label: 'Low: 1-20' },
                { color: '#ccece6', label: 'No Data: 0' }    
            ];
            // Add title for the legend
            div.innerHTML += '<b>Fatal Drug Overdoses</b><br/>per County in Washington<br/><br>';
            fatalLegendItems.forEach(function(item) {
                div.innerHTML += `<i style="background: ${item.color}"></i><p>${item.label}</p>`;
            });
            return div;
        };

        // Create Leaflet control object for the legend
        var nonFatalLegend = L.control({ position: 'bottomright' });
        nonFatalLegend.onAdd = function(map) {
            var div = L.DomUtil.create('div', 'legend');
            // Array of legend items
            var nonFatalLegendItems = [
                { color: '#08519c', label: 'Very High: 1995+' },
                { color: '#3182bd', label: 'High: 958-1994' },
                { color: '#6baed6', label: 'Medium: 167-957' },
                { color: '#bdd7e7', label: 'Low: 47-166' },
                { color: '#eff3ff', label: 'Very Low: 1-46' }    
            ];
            div.innerHTML += '<b>Non-Fatal Drug Overdoses</b><br/>per County in Washington<br/><br>';
            nonFatalLegendItems.forEach(function(item) {
                div.innerHTML += `<i style="background: ${item.color}"></i><p>${item.label}</p>`;
            });
            return div;
        };

        // Listen for overlay add/remove events to switch legends
        map.on('layeradd', function(event) {
            if (event.layer === nonFatalOverdoseLayer2003 || event.layer === nonFatalOverdoseLayer2013) {
                map.removeControl(fatalLegend);
                nonFatalLegend.addTo(map);
            } else if (event.layer === fatalOverdoseLayer2003 || event.layer === fatalOverdoseLayer2013) {
                map.removeControl(nonFatalLegend);
                fatalLegend.addTo(map);
            }
        });

        map.on('overlayremove', function(event) {
            if (event.layer === fatalOverdoseLayer2003 || event.layer === fatalOverdoseLayer2013) {
                map.removeControl(fatalLegend);
            } else if (event.layer === nonFatalOverdoseLayer2003 || event.layer === nonFatalOverdoseLayer2013) {
                map.removeControl(nonFatalLegend);
            }
        });

        // Add the search geocoder control to the map
        var geocoder = L.Control.geocoder({
            position: "topleft",
            placeholder: "Enter place name",
            errorMessage: "No place found.",
        })
        .on('result', function(place) {
            // Set map view to the searched location
            map.setView(place.latlng, 13); 
            // Remove previous search marker if it exists
            if (window.searchMarker) {
                map.removeLayer(window.searchMarker);
            }
            // Add a new marker for the search result
            window.searchMarker = L.marker(place.latlng).addTo(map)
                .bindPopup(place.query) // Bind the place name to the marker
                .openPopup(); // Automatically open the popup
        })
        .addTo(map);
	</script>
</body>
</html>